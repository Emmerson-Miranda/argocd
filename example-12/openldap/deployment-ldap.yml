---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ldifs
data:
  users.ldif: |
    # LDIF Export for dc=example,dc=org
    # Server: openldap (openldap)
    # Search Scope: sub
    # Search Filter: (objectClass=*)
    # Total Entries: 7
    #
    # Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on March 9, 2024 5:57 pm
    # Version: 1.2.5

    version: 1

    # Entry 1: dc=example,dc=org
    #dn: dc=example,dc=org
    #dc: example
    #o: Example Inc.
    #objectclass: top
    #objectclass: dcObject
    #objectclass: organization

    # Entry 2: ou=groups,dc=example,dc=org
    dn: ou=groups,dc=example,dc=org
    objectclass: organizationalUnit
    objectclass: top
    ou: groups

    # Entry 3: cn=devops,ou=groups,dc=example,dc=org
    dn: cn=devops,ou=groups,dc=example,dc=org
    cn: devops
    gidnumber: 503
    objectclass: posixGroup
    objectclass: top

    # Entry 4: cn=devs,ou=groups,dc=example,dc=org
    dn: cn=devs,ou=groups,dc=example,dc=org
    cn: devs
    gidnumber: 502
    objectclass: posixGroup
    objectclass: top

    # Entry 5: ou=people,dc=example,dc=org
    dn: ou=people,dc=example,dc=org
    objectclass: organizationalUnit
    objectclass: top
    ou: people

    # Entry 6: cn=dmiranda,ou=people,dc=example,dc=org
    dn: cn=dmiranda,ou=people,dc=example,dc=org
    cn: dmiranda
    gidnumber: 502
    givenname: Daniel
    homedirectory: /home/users/dmiranda
    objectclass: inetOrgPerson
    objectclass: posixAccount
    objectclass: top
    sn: Miranda
    uid: dmiranda
    uidnumber: 1001
    userpassword: {MD5}cfJrbp5Z+3onu8lj8L91Dg==

    # Entry 7: cn=emiranda,ou=people,dc=example,dc=org
    dn: cn=emiranda,ou=people,dc=example,dc=org
    cn: emiranda
    gidnumber: 503
    givenname: Emmerson
    homedirectory: /home/users/emiranda
    objectclass: inetOrgPerson
    objectclass: posixAccount
    objectclass: top
    sn: Miranda
    uid: emiranda
    uidnumber: 1000
    userpassword: {MD5}fRBe1YlTtJul0WtDF4xWUA==
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openldap
  labels:
    app.kubernetes.io/name: openldap
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: openldap
  replicas: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: openldap
    spec:
      containers:
        - name: openldap
          image: osixia/openldap:1.5.0
          imagePullPolicy: "Always"
          volumeMounts:
          - name: ldifs-volume
            mountPath: /ldif
          resources: 
            limits:
              cpu: 300m
              memory: 256Mi
          env:
            - name: LDAP_USERS
              value: "customuser1"
            - name: LDAP_PASSWORDS
              value: "custompassword1"
            - name: LDAP_ADMIN_USERNAME
              value: "admin"
            - name: LDAP_ROOT
              value: "dc=example,dc=org"
            - name: LDAP_ADMIN_DN
              value: "cn=admin,dc=example,dc=org"
            - name: LDAP_LOG_LEVEL
              value: "256"
            - name: LDAP_ORGANISATION
              value: "Example Inc."
            - name: LDAP_DOMAIN
              value: "example.org"
            - name: LDAP_BASE_DN
              value: ""
            - name: LDAP_ADMIN_PASSWORD
              value: "admin"
            - name: LDAP_CONFIG_PASSWORD
              value: "config"
            - name: LDAP_READONLY_USER
              value: "false"
            - name: LDAP_RFC2307BIS_SCHEMA
              value: "false"
            - name: LDAP_BACKEND
              value: "mdb"
            - name: LDAP_TLS
              value: "true"
            - name: LDAP_TLS_CRT_FILENAME
              value: "ldap.crt"
            - name: LDAP_TLS_KEY_FILENAME
              value: "ldap.key"
            - name: LDAP_TLS_DH_PARAM_FILENAME
              value: "dhparam.pem"
            - name: LDAP_TLS_CA_CRT_FILENAME
              value: "ca.crt"
            - name: LDAP_TLS_ENFORCE
              value: "false"
            - name: LDAP_TLS_CIPHER_SUITE
              value: "SECURE256:-VERS-SSL3.0"
            - name: LDAP_TLS_VERIFY_CLIENT
              value: "demand"
            - name: LDAP_REPLICATION
              value: "false"
            - name: KEEP_EXISTING_CONFIG
              value: "false"
            - name: LDAP_REMOVE_CONFIG_AFTER_SETUP
              value: "true"
            - name: LDAP_SSL_HELPER_PREFIX
              value: "ldap"
          ports:
            - name: tcp-ldap
              containerPort: 389
            - name: tcp-ldap2
              containerPort: 636
      volumes:
        - name: ldifs-volume
          configMap:
            name: ldifs
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: phpldapadmin
  labels:
    app.kubernetes.io/name: phpldapadmin
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: phpldapadmin
  replicas: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: phpldapadmin
    spec:
      containers:
        - name: phpldapadmin
          image: osixia/phpldapadmin:latest
          imagePullPolicy: "Always"
          resources: 
            limits:
              cpu: 300m
              memory: 256Mi
          env:
            - name: PHPLDAPADMIN_LDAP_HOSTS
              value: "openldap"
            - name: PHPLDAPADMIN_HTTPS
              value: "false"
          ports:
            - name: tcp-phpldap
              containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: openldap
  labels:
    app.kubernetes.io/name: openldap
spec:
  type: NodePort
  ports:
    - name: tcp-ldap
      port: 389
      targetPort: tcp-ldap
  selector:
    app.kubernetes.io/name: openldap
---
apiVersion: v1
kind: Service
metadata:
  name: phpldapadmin
  labels:
    app.kubernetes.io/name: phpldapadmin
spec:
  type: NodePort
  ports:
    - name: tcp-phpldap
      nodePort: 30080
      port: 80
      targetPort: tcp-phpldap
  selector:
    app.kubernetes.io/name: phpldapadmin
---
# kubectl create secret generic openldap --from-literal=adminpassword=adminpassword --from-literal=users=user01,user02 --from-literal=passwords=password01,password02
#apiVersion: v1
#data:
#  adminpassword: YWRtaW5wYXNzd29yZA==
#  passwords: cGFzc3dvcmQwMSxwYXNzd29yZDAy
#  users: dXNlcjAxLHVzZXIwMg==
#kind: Secret
#metadata:
#  name: openldap
